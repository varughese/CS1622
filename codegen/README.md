<div class="tyJCtd mGzaTb baZpAe">

# Part IV: Code Generation
- View `optimization.md` for optimization design descisions.

<p id="h.p_zU8YwL64TbqS" class="zfr3Q">In this part of the project you will implement the code generation stage of your compiler, producing MIPS assembly code as a result. This is the most exciting part that will finally emit working assembly code. The code generation will be performed using the AST and symbol table produced during the syntactic and semantic analysis. Here we are mostly interested in the compiler correctness, and not concerned about the efficiency of the resulting assembly code. An important advice is to start with some extremely simple programs (e.g. "void main(void) { return 2+3; }") and gradually add complexity bit by bit. </p><p id="h.p_r8VvTgK4Yp24" class="zfr3Q">A practical reference for this part of the project can be found on <a class="dhtgD aw5Odc" href="https://www.google.com/url?q=https%3A%2F%2Fwww3.nd.edu%2F~dthain%2Fcompilerbook%2Fchapter11.pdf&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHfT_3SeZqofnL6ZLbJNy0OcD7F8Q" target="_blank">Chapter 11 â€“ Code Generation</a> from the book "Introduction to Compilers and Language Design" by Douglas Thain. While the examples in the chapter is given in X86-64 assembly, it should not be hard to adapt to the MIPS assembly (our target language).</p><h3 id="h.p_QWItQ-6TTbqT" class="zfr3Q OmQG5e" tabindex="-1"><div jscontroller="Ae65rd" jsaction="touchstart:UrsOsc; click:KjsqPd; focusout:QZoaZ; mouseover:y0pDld; mouseout:dq0hvd;fv1Rjc:jbFSOd;CrfLRd:SzACGe;" class="CjVfdc"><div class="PPhIP rviiZ" jsname="haAclf"><div role="presentation" class="U26fgb mUbCce fKz7Od LRAOtb rm120e" jscontroller="mxS5xe" jsaction="click:cOuCgd; mousedown:UX7yZ; mouseup:lbsD7e; mouseenter:tfO1Yc; mouseleave:JywGue; focus:AHmuwe; blur:O22p3e; contextmenu:mg9Pef;" jsshadow="" aria-describedby="h.p_QWItQ-6TTbqT" aria-label="Copy heading link" aria-disabled="false" data-tooltip="Copy heading link" aria-hidden="true" data-tooltip-position="top" data-tooltip-vertical-offset="12" data-tooltip-horizontal-offset="0"><a class="FKF6mc TpQm9d" href="#h.p_QWItQ-6TTbqT" aria-label="Copy heading link" jsname="hiK3ld" role="button" aria-describedby="h.p_QWItQ-6TTbqT"><div class="VTBa7b MbhUzd" jsname="ksKsZd"></div><span jsslot="" class="xjKiLb"><span class="Ce1Y1c" style="top: -11px"><svg class="OUGEr uav4k" width="22px" height="22px" viewBox="0 0 24 24" fill="currentColor" focusable="false"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></span></span></a></div></div>MIPS Simulator</div></h3><p id="h.p_A0Vq4WNaTbqT" class="zfr3Q">To evaluate your compiler that produces code for the target language (MIPS assembly) we will use the SPIM simulator (details in the manual <a class="dhtgD aw5Odc" href="https://www.google.com/url?q=https%3A%2F%2Fweb.stanford.edu%2Fclass%2Fcs143%2Fmaterials%2FSPIM_Manual.pdf&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHTiQBs0pwu6ulVP3rO6PyHmhpqNg" target="_blank">here</a>). The SPIM (MIPS32 simulator) can be downloaded <a class="dhtgD aw5Odc" href="http://www.google.com/url?q=http%3A%2F%2Fspimsimulator.sourceforge.net%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNEE3GRSQ8Z3SmAoPjNDO-mB3qt4Ag" target="_blank">here</a>. If you use Ubuntu Linux, you can simply install SPIM with the command "<strong>sudo apt-get install spim</strong>". Refer to this <a class="dhtgD aw5Odc" href="https://www.google.com/url?q=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F19612459%2Fmips-how-does-mips-allocate-memory-for-arrays-in-the-stack&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGLlwqqqVbhfVZ_qgqF6lC2jA1cyw" target="_blank">discussion</a> if you have questions about how to allocate memory in MIPS for variables (global and local) and dynamically (Heap) arrays.</p><h3 id="h.p_9X9V8IZHTbqU" class="zfr3Q OmQG5e" style="text-align: left;" tabindex="-1"><div jscontroller="Ae65rd" jsaction="touchstart:UrsOsc; click:KjsqPd; focusout:QZoaZ; mouseover:y0pDld; mouseout:dq0hvd;fv1Rjc:jbFSOd;CrfLRd:SzACGe;" class="CjVfdc"><div class="PPhIP rviiZ" jsname="haAclf"><div role="presentation" class="U26fgb mUbCce fKz7Od LRAOtb rm120e" jscontroller="mxS5xe" jsaction="click:cOuCgd; mousedown:UX7yZ; mouseup:lbsD7e; mouseenter:tfO1Yc; mouseleave:JywGue; focus:AHmuwe; blur:O22p3e; contextmenu:mg9Pef;" jsshadow="" aria-describedby="h.p_9X9V8IZHTbqU" aria-label="Copy heading link" aria-disabled="false" data-tooltip="Copy heading link" aria-hidden="true" data-tooltip-position="top" data-tooltip-vertical-offset="12" data-tooltip-horizontal-offset="0"><a class="FKF6mc TpQm9d" href="#h.p_9X9V8IZHTbqU" aria-label="Copy heading link" jsname="hiK3ld" role="button" aria-describedby="h.p_9X9V8IZHTbqU"><div class="VTBa7b MbhUzd" jsname="ksKsZd"></div><span jsslot="" class="xjKiLb"><span class="Ce1Y1c" style="top: -11px"><svg class="OUGEr uav4k" width="22px" height="22px" viewBox="0 0 24 24" fill="currentColor" focusable="false"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></span></span></a></div></div>Input/output</div></h3><p id="h.p_zO09C1KdTbqU" class="zfr3Q" style="text-align: left;">Your compiler implementation must support the following input and output functions:</p><ul class="n8H08c UVNKR" style="text-align: left;"><li id="h.p_5dhD2hWsTbqV" class="TYR86d zfr3Q TdnrEb"><code class="qM9fHf">int input(void) {...}</code> - takes no parameters and returns an integer value from the standard input device</li><li id="h.p_lgmMuUH6TbqW" class="TYR86d zfr3Q TdnrEb"><code class="qM9fHf">void output(int x) {...}</code> - displays the integer value passed as parameter in the standard output, followed by a line break (\n).</li></ul><p id="h.p_ZJnB2NSFTbqW" class="zfr3Q" style="text-align: left;">These functions are not defined in the language grammar, but rather as part of the runtime environment. To implement them, you must use specific system calls ("print_int" and "read_int") available in SPIM (see details <a class="dhtgD aw5Odc" href="https://www.google.com/url?q=https%3A%2F%2Fwww.doc.ic.ac.uk%2Flab%2Fsecondyear%2Fspim%2Fnode8.html&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNE-PkZsQIHkhxIirtjWBZE2rru0dA" target="_blank">here</a>).</p><h3 id="h.p_7ol_efc-TbqX" dir="ltr" class="zfr3Q OmQG5e" style="text-align: left;" tabindex="-1"><div jscontroller="Ae65rd" jsaction="touchstart:UrsOsc; click:KjsqPd; focusout:QZoaZ; mouseover:y0pDld; mouseout:dq0hvd;fv1Rjc:jbFSOd;CrfLRd:SzACGe;" class="CjVfdc"><div class="PPhIP rviiZ" jsname="haAclf"><div role="presentation" class="U26fgb mUbCce fKz7Od LRAOtb rm120e" jscontroller="mxS5xe" jsaction="click:cOuCgd; mousedown:UX7yZ; mouseup:lbsD7e; mouseenter:tfO1Yc; mouseleave:JywGue; focus:AHmuwe; blur:O22p3e; contextmenu:mg9Pef;" jsshadow="" aria-describedby="h.p_7ol_efc-TbqX" aria-label="Copy heading link" aria-disabled="false" data-tooltip="Copy heading link" aria-hidden="true" data-tooltip-position="top" data-tooltip-vertical-offset="12" data-tooltip-horizontal-offset="0"><a class="FKF6mc TpQm9d" href="#h.p_7ol_efc-TbqX" aria-label="Copy heading link" jsname="hiK3ld" role="button" aria-describedby="h.p_7ol_efc-TbqX"><div class="VTBa7b MbhUzd" jsname="ksKsZd"></div><span jsslot="" class="xjKiLb"><span class="Ce1Y1c" style="top: -11px"><svg class="OUGEr uav4k" width="22px" height="22px" viewBox="0 0 24 24" fill="currentColor" focusable="false"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></span></span></a></div></div>Reference compiler (code generation)</div></h3><ul dir="ltr" class="n8H08c UVNKR" style="text-align: left;"><ul class="n8H08c UVNKR"><li id="h.p_jB1NLLlYTbqX" class="TYR86d zfr3Q">Sample binary (Linux ELF 64-bit LSB executable, x86-64) <a class="dhtgD aw5Odc" href="https://www.google.com/url?q=https%3A%2F%2Fpitt-my.sharepoint.com%2F%3Au%3A%2Fg%2Fpersonal%2Fvtp4_pitt_edu%2FEZCPA3-vrjFPq-7MuM7SVU8BYD8j8hGQqqgvy8E7tOU5Bg%3Fe%3Db2UuO6&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNG3Lz2ktcAvDz0IWuNNvUBxL-lJhQ" target="_blank">here</a><ul class="n8H08c UVNKR"><li id="h.p_6UUgadN4TbqX" class="TYR86d zfr3Q">If you're using Windows, you can install and use the Linux Ubuntu terminal! See <a class="dhtgD aw5Odc" href="https://www.google.com/url?q=https%3A%2F%2Ftutorials.ubuntu.com%2Ftutorial%2Ftutorial-ubuntu-on-windows&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHGZGmj-RPsE_2PokGCnxIWJa-4Sg" target="_blank">this tutorial</a></li></ul></li><li id="h.p_4rbcAxyNTbqY" class="TYR86d zfr3Q">Input files <a class="dhtgD aw5Odc" href="https://www.google.com/url?q=https%3A%2F%2Fpitt-my.sharepoint.com%2F%3Au%3A%2Fg%2Fpersonal%2Fvtp4_pitt_edu%2FEa4aWedbrXlElFtPoNYgIAoB_QjQj6hfh0NGBkApjoT2CA%3Fe%3DUW25Xy&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNFLoAtM3toZyVIjLHZUjVbHPvW2Xw" target="_blank">here</a></li></ul></ul><h3 id="h.p_HtFkNVzdTbqY" class="zfr3Q OmQG5e" style="text-align: left;" tabindex="-1"><div jscontroller="Ae65rd" jsaction="touchstart:UrsOsc; click:KjsqPd; focusout:QZoaZ; mouseover:y0pDld; mouseout:dq0hvd;fv1Rjc:jbFSOd;CrfLRd:SzACGe;" class="CjVfdc"><div class="PPhIP rviiZ" jsname="haAclf"><div role="presentation" class="U26fgb mUbCce fKz7Od LRAOtb rm120e" jscontroller="mxS5xe" jsaction="click:cOuCgd; mousedown:UX7yZ; mouseup:lbsD7e; mouseenter:tfO1Yc; mouseleave:JywGue; focus:AHmuwe; blur:O22p3e; contextmenu:mg9Pef;" jsshadow="" aria-describedby="h.p_HtFkNVzdTbqY" aria-label="Copy heading link" aria-disabled="false" data-tooltip="Copy heading link" aria-hidden="true" data-tooltip-position="top" data-tooltip-vertical-offset="12" data-tooltip-horizontal-offset="0"><a class="FKF6mc TpQm9d" href="#h.p_HtFkNVzdTbqY" aria-label="Copy heading link" jsname="hiK3ld" role="button" aria-describedby="h.p_HtFkNVzdTbqY"><div class="VTBa7b MbhUzd" jsname="ksKsZd"></div><span jsslot="" class="xjKiLb"><span class="Ce1Y1c" style="top: -11px"><svg class="OUGEr uav4k" width="22px" height="22px" viewBox="0 0 24 24" fill="currentColor" focusable="false"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></span></span></a></div></div>Example</div></h3><ul dir="ltr" class="n8H08c UVNKR" style="text-align: left;"><li id="h.p_1yv71JHVTbqZ" class="TYR86d zfr3Q"><strong>Simple input file</strong></li></ul><div class="s1gOZb"><pre id="h.p_cMr1ulfSTbqZ" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>void main(void) { output(4+5); }</code></pre></div><ul dir="ltr" class="n8H08c UVNKR" style="text-align: left;"><li id="h.p_8T4V_83-Tbqa" class="TYR86d zfr3Q"><strong>Run your compiler while receiving two arguments (input file and output file)</strong></li></ul><div class="s1gOZb"><pre id="h.p_D4YG-DE5Tbqc" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>$ ./codegen ex.c ex.s</code></pre></div><ul dir="ltr" class="n8H08c UVNKR" style="text-align: left;"><li id="h.p_s7E5xtj7Tbqd" class="TYR86d zfr3Q"><strong>Example of output file (ex.s) in MIPS assembly:</strong></li></ul><div class="s1gOZb"><pre id="h.p_WesB2eblTbqd" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>.data</code></pre><pre id="h.p_movmT2zATbqd" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><br></pre><pre id="h.p_TpHmHe-_Tbqe" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>.text</code></pre><pre id="h.p_xlfZnLaLTbqe" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><br></pre><pre id="h.p_EYLX1jibTbqf" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>_f_output:</code></pre><pre id="h.p_0ndig-ZxTbqf" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  lw $a0, 4($sp)</code></pre><pre id="h.p_zWMwt8VMTbqf" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  li $v0, 1</code></pre><pre id="h.p_QH6JoCQXTbqg" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  syscall</code></pre><pre id="h.p_gfk6rFizTbqg" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  li $v0, 11</code></pre><pre id="h.p_oEgmguk3Tbqg" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  li $a0, 0x0a</code></pre><pre id="h.p_dm3tH9BjTbqh" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  syscall</code></pre><pre id="h.p_Hl08KkS9Tbqh" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  addiu $sp, $sp, 4</code></pre><pre id="h.p_ote-7vTuTbqi" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  li $a0, 0</code></pre><pre id="h.p_K8Y2GNV8Tbqi" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  j $ra</code></pre><pre id="h.p_h-UZ8JePTbqi" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><br></pre><pre id="h.p_GDCUkd5MTbql" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>_f_main:</code></pre><pre id="h.p_sVyMhwnxTbqm" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  sw $ra, 0($sp)</code></pre><pre id="h.p_T18dJvGRTbqm" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  addiu $sp, $sp, -4</code></pre><pre id="h.p_64-6a3bCTbqm" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  li $a0, 4</code></pre><pre id="h.p_Lia92bi6Tbqn" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  sw $a0, 0($sp)</code></pre><pre id="h.p_Np52h8LJTbqo" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  addiu $sp, $sp, -4</code></pre><pre id="h.p_b1IeiGSRTbqo" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  li $a0, 5</code></pre><pre id="h.p_-yvqVDAyTbqp" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  lw $t1, 4($sp)</code></pre><pre id="h.p_janVOdsXTbqp" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  addiu $sp, $sp, 4</code></pre><pre id="h.p_LNzXlZg1Tbqq" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  add $a0, $t1, $a0</code></pre><pre id="h.p_oq8ibHpBTbqq" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  sw $a0, 0($sp)</code></pre><pre id="h.p_GDp2ewdeTbqr" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  addiu $sp, $sp, -4</code></pre><pre id="h.p_ed9RDQHaTbqr" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  jal _f_output</code></pre><pre id="h.p_tO-LbDeLTbqs" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  lw $ra, 4($sp)</code></pre><pre id="h.p_mUQ3MWdzTbqs" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  addiu $sp, $sp, 4</code></pre><pre id="h.p_tCMOvSB3Tbqt" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  j $ra</code></pre><pre id="h.p_69wHT6wETbqt" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><br></pre><pre id="h.p_4hT1VDNSTbqt" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>main:</code></pre><pre id="h.p_OHKTjIUYTbqv" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  jal _f_main</code></pre><pre id="h.p_Kx-fIkpWTbqv" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  li $v0, 10</code></pre><pre id="h.p_kNAZjbmBTbqw" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>  syscall</code></pre></div><ul dir="ltr" class="n8H08c UVNKR" style="text-align: left;"><li id="h.p_cTqvktq7Tbqw" class="TYR86d zfr3Q"><strong>Executing MIPS output code using the SPIM simulator</strong></li></ul><p id="h.p_Sr9hWvRYTbqw" dir="ltr" class="zfr3Q" style="text-align: left;"><em>It is important to know that the output of the SPIM simulator will be considered, in which the instructions of the assembly code produced will be executed to evaluate the correctness of the your compiler implementation.</em></p><div class="s1gOZb"><pre id="h.p_r4GxBggqTbqx" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>$ spim -file ex.as</code></pre><pre id="h.p_OyEtdOA2Tbqx" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>SPIM Version 8.0 of January 8, 2010</code></pre><pre id="h.p_4Iz56NDHTbqy" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>Copyright 1990-2010, James R. Larus.</code></pre><pre id="h.p_Y-WX_KDUTbqy" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>All Rights Reserved.</code></pre><pre id="h.p_uXJPuLphTbqz" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>See the file README for a full copyright notice.</code></pre><pre id="h.p_iQjC-z5hTbqz" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code>Loaded: /usr/lib/spim/exceptions.s</code></pre><pre id="h.p_UAmVobRvTbq0" dir="ltr" class="zfr3Q FVr0A" style="text-align: left;"><code><strong>9</strong></code></pre></div></div>